name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[dev]"
          # Explicitly install missing tools (remove once added to pyproject.toml [dev])
          pip install ruff mypy flake8 bandit

      - name: Lint with flake8 (non-blocking)
        continue-on-error: true
        run: |
          echo "Running flake8 (warnings only - will not fail the job)"
          flake8 djpaystack \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics || true

          flake8 djpaystack \
            --count \
            --exit-zero \
            --max-complexity=10 \
            --max-line-length=100 \
            --statistics || true

      - name: Format check with Black (non-blocking)
        continue-on-error: true
        run: black --check --diff djpaystack || true

      - name: Import sort check with isort (non-blocking)
        continue-on-error: true
        run: isort --check-only --diff djpaystack || true

      - name: Type check with mypy
        run: mypy djpaystack --strict --ignore-missing-imports
        # Keep blocking â€” type errors often hide real bugs

      - name: Security scan with Bandit (non-blocking)
        continue-on-error: true
        run: bandit -r djpaystack -ll -ii || true

      # Optional: Ruff-based lint (once Ruff is configured properly)
      # - name: Ruff lint + format check (non-blocking variant)
      #   continue-on-error: true
      #   run: |
      #     ruff check --output-format=github djpaystack || true
      #     ruff format --check djpaystack || true
